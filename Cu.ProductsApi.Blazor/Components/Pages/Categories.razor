@page "/categories"
@inject IProductService ProductService
@if(error is not null)
{ 
    <ErrorComponent>@error</ErrorComponent>
}
else
{ 
    if(categoryModels is null)
    { 
        <LoadingComponent></LoadingComponent>
    }
    else
    { 
        @if(selectedCategory is null)
        {
            <CategoryList CategoryModels="categoryModels"
                          OnAdd="Add"
                          OnEdit="Update"
                          OnDelete="Delete"
                          ></CategoryList>
        }
        else
        { 
            //show the add category form
            <CategoryForm CategoryModel="selectedCategory"
                          OnCancel="Cancel"
                          OnSave="Create"
                          ></CategoryForm>
        }
    }
}
@code {
    private IEnumerable<CategoryModel> categoryModels;
    private CategoryModel selectedCategory;
    private string error = null;

    protected async override Task OnInitializedAsync()
    {
        //get the categories
        await GetCategories();
    }
    private async Task GetCategories()
    {
        error = null;
        var result = await ProductService.GetAllCategoriesAsync();
        if (result.IsSuccess)
        {
            categoryModels = result.Data;
        }
        else
        {
            error = result.Errors.First();
        }
    }
    /*crud methods*/
    //pass this as callback method to the categoriesList
    private void Add()
    {
        selectedCategory = new();
    }
    private void Update(CategoryModel toUpdate)
    {
        selectedCategory = toUpdate;
    }
    private void Cancel()
    {
        selectedCategory = null;
    }
    private async Task Delete(CategoryModel toDelete)
    {
        categoryModels = null;
        var result = await ProductService.DeleteCategoryAsync(toDelete.Id);
        if(!result.IsSuccess)
        {
            error = result.Errors.First(); //to be quick and dirty
        }
        selectedCategory = null;
        await GetCategories();
    }
    private async Task Create(CategoryModel categoryModel)
    {
        categoryModels = null;
        if(categoryModel.Id == 0)
        {
            await ProductService.CreateCategoryAsync(categoryModel);
        }
        else
        {
            await ProductService.UpdateCategoryAsync(categoryModel);
        }
        selectedCategory = null;
        await GetCategories();
    }
}
